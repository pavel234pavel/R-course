---
title: 'Домашнее задание 2'
output:
  html_document:
    keep_md: no
    number_sections: yes
    toc: yes
lang: ru-RU
editor_options:
  chunk_output_type: console
---

Во второй домашке узнаем всё про пассажиров Титаника и закрепим изученное на семинаре :)

Прежде всего — библиотеки!

* **Упражнение 0.**

Отключите в этом куске кода сообщения и предупреждения.

```{r, message=FALSE, warning=FALSE}
library(tidyverse) # обработка данных, графики...
library(vcd) # мозаичные графики для качественных переменных
library(skimr) # описательные статистики
library(rio) # импорт фантастического количества форматов данных
library(ggalluvial) # потоковые диаграммы для качественных переменных
library(corrplot) # визуализация корреляций
library(reshape2) # длинные и широкие таблицы
```

Описание данных:

- Survived - выжил ли пассажир (1 — да, 0 — нет)

- Pclass - класс билета (1 — первый, 2 — второй, 3 — третий)

- Name - имя пассажира

- Sex - пол пассажира

- Age - возраст пассажира

- SibSp - число братьев или сестер / присутствие мужа или жены на корабле

- Parch - количество детей / родителей на корабле

- Ticket - номер билета

- Fare - стоимость билета

- Cabin - номер каюты

- Embarked - порт посадки (C = Cherbourg, Q = Queenstown, S = Southampton)

Прежде всего положим данные в переменную `df` и посмотрим описателные статистики.

```{r}
df <- import("titanic.csv")
___
```

- Сколько наблюдений в данных?

- Сколько переменных?

- Все ли переменные соответсвуют своему типу по смыслу?

* **Упражнение 1.**

Пассажиры Титаника могли попасть на корабаль из трёх портов, два из которых находились в Великобритании, а один во Франции.

- Какова частотность каждой категории в столбце `Embarked`?

- Объедините британские порты Саутгемптон и Квинстаун в одну категорию `GB` и сохраните результат в переменной df2.

- Что стало с частотностью категорий `Embarked` в новой таблице `df2`

```{r}
table(___)
df2 <- mutate(___, ____ = fct_collapse(___, ___ = c("___", "___")))
table(___)
```


* **Упражнение 2.**

Выясним, как связаны класс каюты пассажира и выживание.

- Составьте таблицу сопряжённости признаков `PClass` и `Survived`.

- Проведите тест на независимость этих признаков.

- Какой вывод можно сделать?

```{r}
ctable <- ___(___, ___)
chisq.test(___)
```

* **Упражнение 3.**

Посмотрим, как соотносятся пол пассажира и класс каюты с его выживанием.

- Составьте таблицу сопряжённости для признаков `Pclass`, `Survived`, `Sex` и сохраните её. Не забудьте добавить названия! За это отвечает аргумент `dnn` :)

- Постройте мозаичный график для получившейся таблицы, обязателно цветной и с легендой!

- Что на нём изображено?

```{r}
ctable <- table(___, ___, ___, dnn = c(___, ___, ___))
mosaic(___, shade = ___, legend = ___)
```

* **Упражнение 4.**

Продолжим исследовать информацию о пассажирах!

- Посчитайте корреляции признаков `Survived`, `Age`, `SibSp`, `Parch`, `Fare`.

- Какой признак сильнее всего коррелирует с выживанием?

- Визуализируйте корреляции: постройте график со значениями выше диагонали и квадратами внутри.

- Для чего понадобился аргумент `use = "pairwise.complete.obs"`?

```{r}
mcor <- cor(df[, c(___, ___, ___, ___, ___)], use = "pairwise.complete.obs")
mcor
corrplot(___, method = ___, type = ___)
```

* **Упражнение 5.**

Посмотрим на распределение возраста пассажиров Титаника.

- Постройте скрипичный график командой `geom_viloin()` из пакета `ggplot2`. Не забудьте подписать оси и придумать название!

- Разбейте график на две панели по признаку `Survived`.

```{r}
df <- mutate(df, Pclass = factor(Pclass))

ggplot(data = ___, aes(x = ___, y = ___)) +
  geom_violin() +
  labs(x = ___, y = ___, title = ___)

ggplot(data = ___, aes(x = ___, y = ___)) +
  geom_violin() +
  facet_grid(___ ~ .) +
  ___
```

* **Упражнение 6.**

Цель задания — построить потоковую диаграмму!

- Посчитайте таблицу частот по переменным `Pclass`, `Sex`, `Survived`. Для этого сгруппируйте наблюдения по этим переменным, а затем для каждой группы посчитайте количество наблюдений `n()`.

- Дополните код для потоковой диаграммы. В качестве аргумента `data` нужно указать созданную таблицу частот, в аргументы `axis_` передайте класс каюты, пол и выживыших в этом порядке. Аргумент `fill` отвечает за цвет потоков — раскрасьте их по классу каюты.

```{r}
freq_table <- group_by(___, ___, ___, ___) %>% summarise(freq = ___)
freq_table

ggplot(data = ___, aes(weight = ___, axis1 = ___, axis2 = ___, axis3 = ___)) +
  geom_alluvium(aes(fill = ___), width = 1/12) +
  geom_stratum(width = 1/8) +
  geom_label(stat = "stratum", label.strata = TRUE) +
  scale_x_continuous(breaks = 1:3, labels = c("Class", "Sex", "Survived"))
```

* **Упражнение 7.**

Постройте широкую таблицу, в которой по строкам будет стоять класс каюты пассажира, по столбцам — количество его братьев и сестёр на корабле, а внутри — средняя цена билета.

```{r}
dcast(___, ___ ~ ___, value.var = "___", fun.aggregate = ___)
```

* **Упражнение 8.**

В вашем распоряжении новые (но недостоверные) данные о пассажирах Титаника.

- Загрузите их из файла `titanic_info.xlsx`.
- Сколько наблюдений в новых данных? Какие переменные совпадают с основными данными?
- Объедините новую таблицу с таблицей `df` всеми возможными способами.
- Для каждого случая определите колчиство наблюдений в получившейся таблице.

```{r}
new_df <- ___("titanic_info.xlsx")

lj <- left_join(___, ___, by = "___")
___

___
___

___
___

___
___
```


Бонус победителю!

Если все упражнения получились, можно смело нажимать `Knit` :)
